<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Konfiguration - EUR/JPY AI Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="title">Konfiguration</div>
        <div class="subtitle">Einstellungen bleiben nach Update des Stacks erhalten</div>
      </div>
      <div class="status">
        <a class="pill link" href="/">Zurueck zum Dashboard</a>
      </div>
    </header>

    <main class="config">
      <form class="card config-card" id="config-form">
        <div class="card-head">
          <div class="h">Allgemein</div>
          <div class="s" id="status">...</div>
        </div>
        <div class="form-grid">
          <label>
            <span>Instrument</span>
            <select name="instrument_key" id="instrument-select"></select>
          </label>
          <label>
            <span>Zeitzone</span>
            <input name="tz" placeholder="Europe/Zurich" />
          </label>
          <label>
            <span>Marktdatenquelle</span>
            <select name="market_data_provider">
              <option value="yahoo">Yahoo Finance (kostenlos)</option>
              <option value="coinbase">Coinbase Exchange (kostenlos, Krypto)</option>
              <option value="alphavantage">Alpha Vantage (API Key)</option>
            </select>
          </label>
          <label>
            <span>Alpha Vantage API Key</span>
            <input name="alphavantage_api_key" placeholder="Optionaler API Key" />
          </label>
          <label>
            <span>Finnhub API Key</span>
            <input name="finnhub_api_key" placeholder="Optionaler API Key" />
          </label>
          <label>
            <span>Polygon.io API Key</span>
            <input name="polygon_api_key" placeholder="Optionaler API Key" />
          </label>
          <label>
            <span>History (Tage)</span>
            <input type="number" min="1" max="200" name="history_days" />
          </label>
          <label>
            <span>Kerzen-Intervall</span>
            <input name="candle_interval" placeholder="15m" />
          </label>
          <label>
            <span>Refresh (Sek.)</span>
            <input type="number" min="30" max="3600" name="refresh_seconds" />
          </label>
          <label>
            <span>Entry Horizont (Std.)</span>
            <input type="number" step="0.5" min="0.5" max="48" name="entry_horizon_hours" />
          </label>
          <label>
            <span>TP Horizont (Std.)</span>
            <input type="number" step="0.5" min="1" max="168" name="tp_horizon_hours" />
          </label>
          <label>
            <span>Gewichtung Technik</span>
            <input type="number" step="0.01" min="0" max="1" name="w_technical" />
          </label>
          <label>
            <span>Gewichtung News</span>
            <input type="number" step="0.01" min="0" max="1" name="w_sentiment" />
          </label>
          <label>
            <span>Score BUY</span>
            <input type="number" step="0.01" min="0" max="1" name="score_buy" />
          </label>
          <label>
            <span>Score SELL</span>
            <input type="number" step="0.01" min="-1" max="0" name="score_sell" />
          </label>
          <label class="full">
            <span>RSS Quellen (eine pro Zeile)</span>
            <textarea name="rss_urls" rows="5"></textarea>
          </label>
        </div>
        <div class="form-actions">
          <button type="submit" class="pill link">Speichern</button>
          <button type="button" class="pill link" id="backup-btn">Backup herunterladen</button>
          <span class="hint">Gespeichert unter /app/data/settings.json (Volume)</span>
        </div>
      </form>
    </main>

    <script>
      const form = document.getElementById("config-form");
      const statusEl = document.getElementById("status");
      const backupBtn = document.getElementById("backup-btn");
      const instrumentSelect = document.getElementById("instrument-select");

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function fillForm(data) {
        for (const [key, value] of Object.entries(data)) {
          const field = form.elements.namedItem(key);
          if (!field) continue;
          if (key === "rss_urls") {
            field.value = (value || []).join("\n");
          } else {
            field.value = value;
          }
        }
      }

      function collect() {
        const data = {};
        for (const el of form.elements) {
          if (!el.name) continue;
          if (el.name === "rss_urls") {
            data[el.name] = el.value
              .split("\n")
              .map((v) => v.trim())
              .filter(Boolean);
          } else if (el.type === "number") {
            data[el.name] = Number(el.value);
          } else {
            data[el.name] = el.value.trim();
          }
        }
        return data;
      }

      async function loadInstruments() {
        const res = await fetch("/api/instruments");
        const data = await res.json();
        instrumentSelect.innerHTML = data.items
          .map((item) => `<option value="${item.key}">${item.label} (${item.display_currency})</option>`)
          .join("");
      }

      async function loadSettings() {
        setStatus("Lade Einstellungen...");
        const res = await fetch("/api/settings");
        const data = await res.json();
        fillForm(data);
        setStatus("Bereit");
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        setStatus("Speichere...");
        const payload = collect();
        const res = await fetch("/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          setStatus("Fehler beim Speichern");
          return;
        }
        const data = await res.json();
        fillForm(data);
        setStatus("Gespeichert");
      });

      backupBtn.addEventListener("click", async () => {
        setStatus("Erstelle Backup...");
        const res = await fetch("/api/backup");
        if (!res.ok) {
          setStatus("Backup fehlgeschlagen");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const disposition = res.headers.get("Content-Disposition");
        const filenameMatch = disposition && disposition.match(/filename="?([^";]+)"?/);
        a.download = filenameMatch ? filenameMatch[1] : "backup.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        setStatus("Backup gespeichert");
      });

      (async () => {
        await loadInstruments();
        await loadSettings();
      })();
    </script>
  </body>
</html>
